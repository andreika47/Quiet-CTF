# Among Aliens
**MCTF 2025**

Сервис предлагает сыграть в игру по угадыванию дверей, чтобы выбраться с корабля с Чужими. Набор уровней и правильных дверей на нес генерируется на основе флага:
1. Создается матрица $M$ размера $32$ на $32$, заполенная нулями 
2. На главной диагонали матрицы $M$ записывается числовое представление байтов флага
3. Диагональ над главной диагональю матрицы $M$ заполняется единицами
4. Генерируется случайная матрица $K$ $32$ на $32$. При этом в качестве seed для генерации случайных чисел используется произведение числовых представлений байтов флага
5. Вычисляется матрица $C = K * M * K^{-1}$
6. От значений матрицы $C$ берется остаток по модуля $5$. Количество дверей на уровне равно этому остатку `+1`
7. Матрица C записывается в файл `/app/matrix-data/{session_id}.json`, где `session_id` - `id` Flask сессии игрока
При анализе исходного кода нужно заметить использование небезопасной функции `send_file`. В коде отсутствует валидация и санитизация данных, попадающих в аргументы функции `send_file`, поэтому мы можем реализовать Path Traversal для получения нашей матрицы. Для этого нам нужен `session_id` нашей сессии - его можно получить декодировав из `base64` куку, которую нам подставил сервис. Итак, чтобы получить файл с матрицей нужно сделать запрос на следующий эндпоинт:
```
/api/images/..%2fmatrix-data/{session_id}.json
```

Теперь мы можем приступить к изучению матрицы.

Из пункта 6: $C = K * M * K^{-1}$. Матрица кажется необычной и погуглив про специальные виды матриц можно дойти до Жордановой нормальной формы (ЖНФ) матрицы. Любую квадратную матрицу $A$ можно представить в виде ЖНФ матрицы $J = B * A * B^{-1}$. При этом матрица $J$ будет следующего вида:
1. На главной диагонали матрицы $J$ стоят ее собственные значения
2. На диагонали выше главной диагонали стоят единицы

Одним из главных свойств матрицы и ЖНФ является их подобие, поэтому из $J = B * A * B^{-1}$ следует, что $A = B * J * B^{-1}$

Получается, что у нас есть матрица $C$, которая представима в виде ЖНФ с участием матрицы $M$. Отсюда следует, что матрицы $C$ и $M$ подобны, а значит у них совпадают собственные значения. Значит, найдя собственные значения матрицы $C$ мы получим собственные значения матрицы $M$, которые должны располагаться на ее главной диагонали - как раз там, где был флаг. Отсюда, что следует, что числовые представления байт флага и есть собственные значения матрицы $C$. Найдя их, например, с помощью Sagemath мы сможем получить `seed`, использовавшийся для генерации матрицы $K$. Восстановив матрицу K из свойства подобия матриц $M$ и $C$ мы можем восстановить $M$:<br>
$$M = K^{-1} * C * K$$

Пример кода с решение [solve.py](https://github.com/andreika47/Quiet-CTF/blob/main/Among%20Aliens/solve.py)


#crypto #matrix #linear_algebra #web #path_traversal
